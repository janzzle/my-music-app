rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ’¡ ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
    function isAdmin() {
      // ì ‘ì†í•œ ì‚¬ìš©ìì˜ UIDë¥¼ ê°€ì§€ê³  'users' ì»¬ë ‰ì…˜ ë¬¸ì„œë¥¼ ì¡°íšŒí•˜ì—¬ isAdmin í•„ë“œê°€ trueì¸ì§€ í™•ì¸
      return request.auth != null && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    // ğŸ’¡ ë¡œê·¸ì¸ ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
    function isAuthenticated() {
      return request.auth != null;
    }

    // 1. ìœ ì € ì •ë³´ (users)
    match /users/{userId} {
      // ì½ê¸°: ì•„ë¬´ë‚˜(ë¡œê·¸ì¸ ë¬´ê´€) í˜¹ì€ ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ ê°€ëŠ¥í•˜ê²Œ ì„¤ì • (í˜„ì¬ëŠ” ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ)
      allow read: if isAuthenticated();
      // ì“°ê¸°: ë³¸ì¸ ë°ì´í„°ë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ê±°ë‚˜, ê´€ë¦¬ìë§Œ ìˆ˜ì • ê°€ëŠ¥
      allow write: if (isAuthenticated() && request.auth.uid == userId) || isAdmin();
    }

    // 2. ì‹ ì²­ê³¡ í ë“± ëŒ€ê¸°ì—´ (challenges)
    match /challenges/{challengeId} {
      // ì½ê¸°: ëˆ„êµ¬ë‚˜ ì½ê¸° ê°€ëŠ¥ (ëŒ€ê¸°ì—´ì„ ë´ì•¼ í•˜ë¯€ë¡œ)
      allow read: if true;
      // ì“°ê¸°: ë¡œê·¸ì¸í•œ ìœ ì €ë¼ë©´ ëˆ„êµ¬ë‚˜ ì‹ ì²­(ìƒì„±) ê°€ëŠ¥, ìˆ˜ì •/ì‚­ì œëŠ” ê´€ë¦¬ìì´ê±°ë‚˜ ë³¸ì¸ì´ ì˜¬ë¦° ê±°ë¼ë©´ ê°€ëŠ¥ (ApplicantUidê°€ ìˆë‹¤ê³  ê°€ì •)
      // ë³´ì•ˆì„ ìœ„í•´ ì—„ê²©íˆ í•˜ë ¤ë©´ ìš°ì„  ê´€ë¦¬ìë§Œ ì“°ê¸°/ìˆ˜ì •/ì‚­ì œ ê°€ëŠ¥í•˜ê²Œ í•œ í›„, ì‹ ì²­ ìƒì„±ë§Œ ê°œë°©
      allow create: if isAuthenticated();
      allow update, delete: if isAdmin();
    }

    // 3. íˆ¬í‘œ ê¸°ë¡ (votes)
    match /votes/{voteId} {
      // ì½ê¸°: ë¡œê·¸ì¸í•œ ì‚¬ëŒë§Œ
      allow read: if isAuthenticated();
      // ì“°ê¸°: ë³¸ì¸ì´ íˆ¬í‘œí•œ ë°ì´í„°(ë¬¸ì„œ idì— uidê°€ í¬í•¨ë˜ê±°ë‚˜, ë¬¸ì„œ ë‚´ uid í•„ë“œê°€ ë³¸ì¸ê³¼ ì¼ì¹˜)ë§Œ ì“°ê¸° í—ˆìš©
      // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ voteë¥¼ ì–´ë–¤ì‹ìœ¼ë¡œ doc(Id) ì§€ì •í•˜ëŠ”ì§€ì— ë”°ë¼ ë‹¤ë¦„. ì—¬ê¸°ì„œëŠ” ë¬¸ì„œ ë‚´ uid í•„ë“œë¥¼ ê²€ì¦.
      allow create: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow update: if isAuthenticated() && request.resource.data.uid == request.auth.uid;
      allow delete: if isAdmin();
    }

    // 4. ë¬´ëŒ€ ì •ë³´ (stage) - ex: stage/info, stage/ranking
    match /stage/{document=**} {
      // ë­í‚¹ì´ë‚˜ ë¬´ëŒ€ ìƒíƒœëŠ” ëˆ„êµ¬ë‚˜(í˜¹ì€ ë¡œê·¸ì¸ ìœ ì €) ë³¼ ìˆ˜ ìˆìŒ
      allow read: if isAuthenticated();
      // ë¬´ëŒ€ ìƒíƒœ ë³€ê²½(ì¹´ìš´íŠ¸ë‹¤ìš´, ì ìˆ˜ ê³µê°œ ë“±)ì€ ê´€ë¦¬ìë§Œ!
      allow write: if isAdmin();
    }

    // 5. ë¬´ëŒ€ ê²°ê³¼ / ì§€ë‚œ ê¸°ë¡ (stage_results)
    match /stage_results/{resultId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin(); // ê²°ì‚°ì€ ê´€ë¦¬ì(AdminPage) ë¡œì§ì—ì„œ ì‹¤í–‰í•˜ë¯€ë¡œ ê´€ë¦¬ìë§Œ ì“°ê¸°
    }
  }
}
